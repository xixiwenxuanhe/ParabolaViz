{% extends "layout.html" %}

{% block title %}å¹³æŠ›è¿åŠ¨{% endblock %}

{% block content %}
<div class="simulation-header">
    <h1 class="gradient-text">å¹³æŠ›è¿åŠ¨æ¨¡æ‹Ÿ</h1>
</div>

<div class="row">
    <div class="col-lg-3 mb-2">
        <div class="simulation-controls card sticky-top">
            <div class="card-body pb-1">
                <div class="form-group mb-1">
                    <label for="initial-velocity" class="form-label mb-0">åˆå§‹é€Ÿåº¦ (m/s)</label>
                    <input type="range" class="form-range" id="initial-velocity" min="1" max="30" step="1" value="10">
                    <div class="d-flex justify-content-between">
                        <span class="small">1</span>
                        <span id="velocity-value" class="small">10 m/s</span>
                        <span class="small">30</span>
                    </div>
                </div>
                <div class="form-group mb-1">
                    <label for="initial-height" class="form-label mb-0">åˆå§‹é«˜åº¦ (m)</label>
                    <input type="range" class="form-range" id="initial-height" min="1" max="30" step="1" value="10">
                    <div class="d-flex justify-content-between">
                        <span class="small">1</span>
                        <span id="height-value" class="small">10 m</span>
                        <span class="small">30</span>
                    </div>
                </div>
            </div>
            
            <div class="card-body theory-section pt-1 border-top">
                <h3 class="section-title text-center mb-3" style="font-size: 16px; font-weight: 600; color: #2a4b8d; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); background: linear-gradient(to right, rgba(67, 97, 238, 0.05), rgba(114, 9, 183, 0.05));">å¹³æŠ›è¿åŠ¨åŸç†</h3>
                <div class="theory-content" style="padding: 5px 0 90px 0; display: flex; flex-direction: column; height: calc(100vh - 220px); overflow-y: auto;">
                    <div class="principle-item" style="margin-bottom: 10px;">
                        <span class="principle-icon" style="font-size: 18px; width: 30px; text-align: center; color: #3a86ff;">ğŸ”„</span>
                        <div style="flex: 1;">
                            <h5 style="font-size: 14px; margin: 0; font-weight: 600; color: #3a86ff;">æ°´å¹³æ–¹å‘</h5>
                            <p style="margin: 0; font-size: 12px;">ç‰©ä½“åšåŒ€é€Ÿç›´çº¿è¿åŠ¨</p>
                        </div>
                    </div>
                    
                    <div class="principle-item" style="margin-bottom: 10px;">
                        <span class="principle-icon" style="font-size: 18px; width: 30px; text-align: center; color: #4361ee;">â¬‡ï¸</span>
                        <div style="flex: 1;">
                            <h5 style="font-size: 14px; margin: 0; font-weight: 600; color: #4361ee;">ç«–ç›´æ–¹å‘</h5>
                            <p style="margin: 0; font-size: 12px;">ç‰©ä½“åšè‡ªç”±è½ä½“è¿åŠ¨</p>
                        </div>
                    </div>
                    
                    <div class="principle-item" style="margin-bottom: 10px;">
                        <span class="principle-icon" style="font-size: 18px; width: 30px; text-align: center; color: #7209b7;">ğŸ“Š</span>
                        <div style="flex: 1;">
                            <h5 style="font-size: 14px; margin: 0; font-weight: 600; color: #7209b7;">è¿åŠ¨è½¨è¿¹</h5>
                            <p style="margin: 0; font-size: 12px;">å½¢æˆåŠä¸ªæŠ›ç‰©çº¿</p>
                        </div>
                    </div>
                    
                    <div class="principle-item" style="margin-bottom: 10px;">
                        <span class="principle-icon" style="font-size: 18px; width: 30px; text-align: center; color: #ff006e;">ğŸ”¬</span>
                        <div style="flex: 1;">
                            <h5 style="font-size: 14px; margin: 0; font-weight: 600; color: #ff006e;">è½åœ°æ—¶é—´</h5>
                            <p style="margin: 0; font-size: 12px;">ä»…ä¸åˆå§‹é«˜åº¦æœ‰å…³</p>
                        </div>
                    </div>

                    <div class="principle-item" style="margin-bottom: 10px;">
                        <span class="principle-icon" style="font-size: 18px; width: 30px; text-align: center; color: #f72585;">ğŸ¯</span>
                        <div style="flex: 1;">
                            <h5 style="font-size: 14px; margin: 0; font-weight: 600; color: #f72585;">æ°´å¹³è·ç¦»</h5>
                            <p style="margin: 0; font-size: 12px;">ä¸åˆå§‹é€Ÿåº¦å’Œè½åœ°æ—¶é—´æœ‰å…³</p>
                        </div>
                    </div>

                    <div class="principle-item" style="margin-bottom: 10px;">
                        <span class="principle-icon" style="font-size: 18px; width: 30px; text-align: center; color: #8338ec;">ğŸ”‹</span>
                        <div style="flex: 1;">
                            <h5 style="font-size: 14px; margin: 0; font-weight: 600; color: #8338ec;">èƒ½é‡è½¬åŒ–</h5>
                            <p style="margin: 0; font-size: 12px;">åŠ¨èƒ½ä¸åŠ¿èƒ½ç›¸äº’è½¬åŒ–</p>
                        </div>
                    </div>
                    
                    <div class="principle-formula" style="margin-top: 10px; padding: 12px; background-color: rgba(0,0,0,0.02); border-radius: 8px;">
                        <h5 style="font-size: 14px; margin: 0 0 8px 0; font-weight: 600; color: #2a4b8d; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px;">åŸºæœ¬å…¬å¼</h5>
                        <p class="formula mb-0" style="font-size: 13px; margin-bottom: 8px !important;">x = v<sub>0</sub>t</p>
                        <p class="formula mb-0" style="font-size: 13px; margin-bottom: 8px !important;">y = h - Â½gtÂ²</p>
                        <p class="formula mb-0" style="font-size: 13px; margin-bottom: 8px !important;">t = âˆš(2h/g)</p>
                        <p class="formula mb-0" style="font-size: 13px; margin-bottom: 8px !important;">R = v<sub>0</sub>âˆš(2h/g)</p>
                    </div>

                    <div class="principle-formula" style="margin-top: 15px; padding: 12px; background-color: rgba(0,0,0,0.02); border-radius: 8px;">
                        <h5 style="font-size: 14px; margin: 0 0 8px 0; font-weight: 600; color: #2a4b8d; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 5px;">èƒ½é‡å…³ç³»</h5>
                        <p class="formula mb-0" style="font-size: 13px; margin-bottom: 8px !important;">E<sub>k</sub> = Â½mvÂ²</p>
                        <p class="formula mb-0" style="font-size: 13px; margin-bottom: 8px !important;">E<sub>p</sub> = mgh</p>
                        <p class="formula mb-0" style="font-size: 13px; margin-bottom: 8px !important;">E<sub>k</sub> + E<sub>p</sub> = å¸¸é‡</p>
                    </div>
                </div>
                
                <div class="control-buttons" style="position: fixed; bottom: 10px; width: calc(100% - 28px); max-width: 250px; display: flex; flex-direction: column; gap: 10px;">
                    <button id="reset-params" class="btn w-100" style="background: linear-gradient(45deg, #4361ee, #7209b7); color: white; border-radius: 20px; font-size: 13px; padding: 8px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; transition: all 0.3s ease;">
                        <i class="fas fa-redo-alt" style="margin-right: 8px;"></i>é‡ç½®å‚æ•°
                    </button>
                    <button id="reset-all-zoom" class="btn w-100" style="background: white; color: #4361ee; border-radius: 20px; font-size: 13px; padding: 8px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(67, 97, 238, 0.3); transition: all 0.3s ease;">
                        <i class="fas fa-search" style="margin-right: 8px;"></i>é‡ç½®ç¼©æ”¾
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <div class="simulation-results">
            <div class="card mb-2">
                <div class="card-header py-1">
                    <h3 class="mb-0">åœ°çƒé‡åŠ›ç¯å¢ƒ (9.8 m/sÂ²)</h3>
                </div>
                <div class="card-body chart-container">
                    <canvas id="earth-chart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header py-1">
                    <h3 class="mb-0">æœˆçƒé‡åŠ›ç¯å¢ƒ (1.62 m/sÂ²)</h3>
                </div>
                <div class="card-body chart-container">
                    <canvas id="moon-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const velocitySlider = document.getElementById('initial-velocity');
    const velocityValue = document.getElementById('velocity-value');
    const heightSlider = document.getElementById('initial-height');
    const heightValue = document.getElementById('height-value');
    
    let earthChart = null;
    let moonChart = null;
    let initialHeight = 10; // é»˜è®¤åˆå§‹é«˜åº¦ä¸º10ç±³
    let isSimulating = false; // æ˜¯å¦æ­£åœ¨è¿›è¡Œæ¨¡æ‹Ÿè®¡ç®—
    let updateTimer = null; // ç”¨äºé˜²æŠ–çš„å®šæ—¶å™¨
    
    // æ›´æ–°é€Ÿåº¦æ˜¾ç¤ºå¹¶è§¦å‘æ¨¡æ‹Ÿ
    velocitySlider.addEventListener('input', function() {
        velocityValue.textContent = this.value + ' m/s';
        scheduleUpdate();
    });
    
    // æ›´æ–°é«˜åº¦æ˜¾ç¤ºå¹¶è§¦å‘æ¨¡æ‹Ÿ
    heightSlider.addEventListener('input', function() {
        initialHeight = parseInt(this.value);
        heightValue.textContent = initialHeight + ' m';
        scheduleUpdate();
    });
    
    // é˜²æŠ–å‡½æ•°ï¼Œé¿å…é¢‘ç¹è§¦å‘æ¨¡æ‹Ÿ
    function scheduleUpdate() {
        if (updateTimer) {
            clearTimeout(updateTimer);
        }
        updateTimer = setTimeout(updateSimulation, 300);
    }
    
    // åˆ›å»ºå›¾è¡¨
    function createChart(canvasId, title) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'å°è´¨é‡',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        showLine: true,
                        tension: 0.1
                    },
                    {
                        label: 'ä¸­è´¨é‡',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        showLine: true,
                        tension: 0.1
                    },
                    {
                        label: 'å¤§è´¨é‡',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        showLine: true,
                        tension: 0.1
                    },
                    {
                        label: 'èµ·å§‹ç‚¹',
                        data: [{x: 0, y: initialHeight}],
                        pointBackgroundColor: 'rgba(255, 0, 0, 1)',
                        pointBorderColor: 'rgba(255, 0, 0, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: title
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `(${context.raw.x.toFixed(2)}, ${context.raw.y.toFixed(2)})`;
                            }
                        }
                    },
                    zoom: {
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        },
                        zoom: {
                            wheel: {
                                enabled: true,
                            },
                            pinch: {
                                enabled: true
                            },
                            mode: 'xy',
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'æ°´å¹³è·ç¦» (m)'
                        },
                        min: 0,
                        max: 100,
                        ticks: {
                            stepSize: 10
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'é«˜åº¦ (m)'
                        },
                        min: 0,
                        max: 40,
                        ticks: {
                            stepSize: 5
                        }
                    }
                }
            }
        });
        
        return chart;
    }
    
    // æ›´æ–°å›¾è¡¨ä¸­çš„èµ·å§‹ç‚¹
    function updateStartingPoint(chart, height) {
        if (!chart) return;
        chart.data.datasets[3].data = [{x: 0, y: height}];
        chart.update();
    }
    
    // æ›´æ–°æ¨¡æ‹Ÿ
    function updateSimulation() {
        if (isSimulating) return; // é¿å…å¤šæ¬¡å¹¶å‘è¯·æ±‚
        
        isSimulating = true;
        const initialVelocity = parseFloat(velocitySlider.value);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        updateStatus('è®¡ç®—ä¸­...');
        
        // å‘é€è¯·æ±‚åˆ°åç«¯ï¼ŒåŒ…æ‹¬åˆå§‹é«˜åº¦
        fetch('/api/projectile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                initial_velocity: initialVelocity,
                initial_height: initialHeight
            })
        })
        .then(response => response.json())
        .then(data => {
            // å¤„ç†åœ°çƒé‡åŠ›ä¸‹çš„ç»“æœ
            if (!earthChart) {
                earthChart = createChart('earth-chart', 'åœ°çƒé‡åŠ›ç¯å¢ƒä¸‹çš„å¹³æŠ›è¿åŠ¨');
            }
            
            // å¤„ç†æœˆçƒé‡åŠ›ä¸‹çš„ç»“æœ
            if (!moonChart) {
                moonChart = createChart('moon-chart', 'æœˆçƒé‡åŠ›ç¯å¢ƒä¸‹çš„å¹³æŠ›è¿åŠ¨');
            }
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            updateChartData(earthChart, data.earth);
            updateChartData(moonChart, data.moon);
            
            // æ¸…é™¤çŠ¶æ€ä¿¡æ¯
            updateStatus('');
        })
        .catch(error => {
            console.error('Error:', error);
            updateStatus('è®¡ç®—å‡ºé”™ï¼Œè¯·é‡è¯•');
        })
        .finally(() => {
            isSimulating = false;
        });
    }
    
    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
    function updateStatus(message) {
        const earthCanvas = document.getElementById('earth-chart');
        const moonCanvas = document.getElementById('moon-chart');
        
        if (message) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            earthCanvas.style.opacity = '0.5';
            moonCanvas.style.opacity = '0.5';
        } else {
            // æ¢å¤æ­£å¸¸æ˜¾ç¤º
            earthCanvas.style.opacity = '1';
            moonCanvas.style.opacity = '1';
        }
    }
    
    // æ›´æ–°å›¾è¡¨æ•°æ®
    function updateChartData(chart, data) {
        // å°è´¨é‡ç‰©ä½“æ•°æ®
        chart.data.datasets[0].data = data.small.x.map((x, i) => ({
            x: x,
            y: data.small.y[i]
        }));
        
        // ä¸­è´¨é‡ç‰©ä½“æ•°æ®
        chart.data.datasets[1].data = data.medium.x.map((x, i) => ({
            x: x,
            y: data.medium.y[i]
        }));
        
        // å¤§è´¨é‡ç‰©ä½“æ•°æ®
        chart.data.datasets[2].data = data.large.x.map((x, i) => ({
            x: x,
            y: data.large.y[i]
        }));
        
        // ç¡®ä¿èµ·å§‹ç‚¹ä½ç½®æ­£ç¡®
        chart.data.datasets[3].data = [{x: 0, y: initialHeight}];
        
        chart.update();
    }
    
    // åˆå§‹åˆ›å»ºç©ºå›¾è¡¨å¹¶è§¦å‘é¦–æ¬¡æ¨¡æ‹Ÿ
    earthChart = createChart('earth-chart', 'åœ°çƒé‡åŠ›ç¯å¢ƒä¸‹çš„å¹³æŠ›è¿åŠ¨');
    moonChart = createChart('moon-chart', 'æœˆçƒé‡åŠ›ç¯å¢ƒä¸‹çš„å¹³æŠ›è¿åŠ¨');
    
    // é¡µé¢åŠ è½½åç«‹å³è¿›è¡Œä¸€æ¬¡æ¨¡æ‹Ÿ
    updateSimulation();
    
    // æ·»åŠ é‡ç½®æ‰€æœ‰ç¼©æ”¾æŒ‰é’®äº‹ä»¶
    document.getElementById('reset-all-zoom').addEventListener('click', function() {
        if (earthChart) {
            earthChart.resetZoom();
        }
        if (moonChart) {
            moonChart.resetZoom();
        }
    });
    
    // æ·»åŠ é‡ç½®å‚æ•°æŒ‰é’®äº‹ä»¶
    document.getElementById('reset-params').addEventListener('click', function() {
        velocitySlider.value = 10;
        heightSlider.value = 10;
        velocityValue.textContent = "10 m/s";
        heightValue.textContent = "10 m";
        initialHeight = 10;
        updateSimulation();
    });
});
</script>
{% endblock %} 